<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dataset Collector{% endblock %}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/editor.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <nav class="side-menu" id="side-menu">
        <div class="menu-header">
            <h2 class="menu-title"><span class="menu-text">Menu</span></h2>
            <div class="toggle-btn" id="toggle-btn">
                <span>&#9776;</span>
            </div>
        </div>
        <ul>
            <li>
                <a href="/" class="{{ 'active' if active_page == 'index' else '' }}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="menu-text">Single Camera View</span>
                </a>
            </li>
            <li>
                <a href="/grid" class="{{ 'active' if active_page == 'grid' else '' }}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                        </path>
                    </svg>
                    <span class="menu-text">Grid View</span>
                </a>
            </li>
            <li>
                <a href="/editor" class="{{ 'active' if active_page == 'editor' else '' }}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                        </path>
                    </svg>
                    <span class="menu-text">Config Editor</span>
                </a>
            </li>
            <li>
                <a href="/sftp" class="{{ 'active' if active_page == 'sftp' else '' }}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                    <span class="menu-text">SFTP Config</span>
                </a>
            </li>
            <li>
                <div class="perf-mode-container">
                    <span class="menu-text" style="flex-grow: 1;">Perf Mode</span>
                    <label class="switch" style="position: relative; display: inline-block; width: 34px; height: 20px;">
                        <input type="checkbox" id="perf-mode-toggle">
                        <span class="slider round"
                            style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                        <!-- Custom CSS for slider pseudo-element needs to be invalid in inline style, using class in style.css recommended but for single file edit constraint I will try to rely on style.css additions I will make next. -->
                    </label>
                </div>
            </li>
        </ul>
    </nav>

    <div id="status-container" class="status-bar">
        <div id="system-stats" class="status-item"
            style="margin-right: 1rem; font-family: monospace; font-size: 0.8rem;">
            CPU: <span id="cpu-stat" class="text-blue-400">--</span>% |
            RAM: <span id="ram-stat" class="text-purple-400">--</span>% |
            Temp: <span id="temp-stat" class="text-red-400">--</span>Â°C
        </div>
        <div id="mqtt-status" class="status-item">
            MQTT <span id="mqtt-status-dot" class="status-dot disconnected"></span>
        </div>
        <div id="ws-status" class="status-item">
            WS <span id="ws-status-dot" class="status-dot disconnected"></span>
        </div>
    </div>

    <main class="page-content" id="page-content">
        {% block content %}{% endblock %}
    </main>

    {% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const perfToggle = document.getElementById('perf-mode-toggle');

            // Function to set UI based on mode
            const applyModeToUI = (mode) => {
                document.body.classList.remove('perf-high', 'perf-low');
                document.body.classList.add(`perf-${mode}`);

                // Toggle state: Checked = High, Unchecked = Low
                if (perfToggle) {
                    perfToggle.checked = (mode === 'high');
                }

                if (mode === 'low') {
                    document.documentElement.style.setProperty('--backdrop-blur', 'none');
                    document.documentElement.style.setProperty('--shadow-intensity', '0');
                } else {
                    document.documentElement.style.removeProperty('--backdrop-blur');
                    document.documentElement.style.removeProperty('--shadow-intensity');
                }
            }

            // Fetch Performance Mode on Load
            fetch('/api/system_stats')
                .then(res => res.json())
                .then(data => {
                    const mode = data.performance_mode || 'high';
                    applyModeToUI(mode);
                    console.log(`Performance Mode: ${mode}`);
                })
                .catch(err => console.error("Error fetching perf mode:", err));

            // Handle Toggle Change
            if (perfToggle) {
                perfToggle.addEventListener('change', (e) => {
                    const newMode = e.target.checked ? 'high' : 'low';

                    // Optimistic UI update
                    applyModeToUI(newMode);

                    // Call API
                    fetch('/api/performance_mode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: newMode })
                    })
                        .then(res => res.json())
                        .then(data => {
                            console.log("Mode saved:", data);
                            // If 'auto' was logic, we might need to handle resolved.
                            // But sidebar switch is explicit 'high' or 'low'.
                        })
                        .catch(err => {
                            console.error("Failed to save mode:", err);
                            // Revert on error?
                        });
                });
            }

            // ... menu logic ...
            const sideMenu = document.getElementById('side-menu');
            const pageContent = document.getElementById('page-content');
            const toggleBtn = document.getElementById('toggle-btn');
            const menuTextSpans = document.querySelectorAll('.menu-text');
            const perfContainer = document.querySelector('.perf-mode-container'); // Get container

            const setMenuState = (isCollapsed) => {
                sideMenu.classList.toggle('collapsed', isCollapsed);
                pageContent.classList.toggle('collapsed', isCollapsed);

                // Handle perf toggle visibility if needed
                if (perfContainer) {
                    // When collapsed, maybe hide the toggle or show simplified?
                    // Currently menu-text class handles text hiding.
                    // The toggle itself might stay visible or hide.
                    // Let's hide the container text manually if needed loop didn't catch it
                    // logic in CSS handles .menu-text
                }

                localStorage.setItem('menuCollapsed', isCollapsed);
            };

            // Check for saved state in localStorage
            const savedState = localStorage.getItem('menuCollapsed') === 'true';
            setMenuState(savedState);

            toggleBtn.addEventListener('click', () => {
                const isCollapsed = !sideMenu.classList.contains('collapsed');
                setMenuState(isCollapsed);
            });
        });
    </script>
    <script src="/static/js/monitor.js"></script>
    {% endblock %}
</body>

</html>